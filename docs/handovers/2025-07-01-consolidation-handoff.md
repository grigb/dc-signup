# Consolidation & Handoff – 2025-07-01

This document explains the **directory-consolidation refactor** completed on 2025-06-30/07-01 and how to continue developing, testing, and deploying the DC-Signup-System going forward.

---

## 1. What Changed

| Area | Before | After |
|------|--------|-------|
| Source directories | `src/`, **plus** a duplicated `cloudflare-deploy/` snapshot | **Single** source: `src/` |
| Deployment output | `cloudflare-deploy/` manually copied | `dist/` auto-generated by `npm run build` |
| CI | none | GitHub Action `.github/workflows/build.yml` builds & guards `dist/` |
| Persistence files | not tracked | `.cascade_chat_id`, `.windsurf_persistent_memory.md` added |
| Backup | n/a | `backup/cloudflare-split` branch keeps full pre-refactor state |

### Removed Artifacts
* Entire `cloudflare-deploy/` directory
* `src/index.html.backup`, `src/README.txt`, other ad-hoc backups

These files **still exist** in Git history (and in `backup/cloudflare-split`) and can be restored via `git checkout` if truly needed.

---

## 2. Directory Structure (High Level)

```
dc-signup-system/
├── src/                # authoritative front-end source
│   ├── assets/         # static files (_headers, images, etc.)
│   ├── ...             # HTML/JS/CSS/Service-worker files
├── dist/               # generated by `npm run build` (ignored in git)
├── docs/               # technical docs (this file, architecture, etc.)
├── .github/workflows/  # CI pipelines
└── ...
```

---

## 3. Build, Test, Deploy

### 3.1 Local dev
```bash
npm install          # first-time setup
npm run dev          # serves src/ at http://localhost:4100
```

### 3.2 Production build
```bash
npm run build        # cleans & copies src → dist/
python3 -m http.server 8000 -d dist  # quick local preview
```

### 3.3 CI (GitHub Actions)
* Workflow: `.github/workflows/build.yml`
* Steps: checkout → `npm ci` → `npm run build` → `git diff --exit-code dist`
* Fails PR if build output differs from committed `dist/` (should never happen).

### 3.4 Cloudflare Pages
1. **Source repo:** `main` (or whichever branch you deploy from).
2. **Build command:** `npm run build` (optional – copy is trivial but keeps parity).
3. **Output directory:** `dist`.
4. Environment variables (Supabase keys, etc.) remain unchanged.

> If you previously pointed Pages at `cloudflare-deploy/`, update to `dist/`.

---

## 4. Verification Checklist After Deploy

| Step | What to Check |
|------|---------------|
| 1 | Open `/` – form loads, assets (logo) render | 
| 2 | Fill signup form – successful local storage & Supabase insert |
| 3 | Email verification flow (Supabase trigger + AWS SES) |
| 4 | Offline mode: disable network, reload – service-worker serves cached assets |
| 5 | Admin/member routes (`/admin.html`, `/member.html`) still work |

Automated Playwright tests live in `tests/`; run with `npx playwright test`.

---

## 5. Front-end ⇄ Back-end Touchpoints

| Area | Technology | File(s) | Notes |
|------|------------|---------|-------|
| Database API | Supabase JS v2 | `src/verify-setup.js`, in-page scripts | Ensure `SUPABASE_URL` & `SUPABASE_ANON_KEY` env vars in Cloudflare |
| Email Verify | Supabase trigger + AWS SES | SQL in `database/`, SES config docs | No code touched in consolidation; run test case in `tests/verify-email` |
| Service Worker | Vanilla JS | `src/sw.js` | Build copies unchanged; verify cache version bump |

---

## 6. How to Restore Removed Files (if ever needed)
```bash
# Option 1: from backup branch
git checkout backup/cloudflare-split -- path/to/file

# Option 2: from specific commit
git checkout <commit-sha> -- cloudflare-deploy/
```
(Prefer cherry-picking changes into `src/`; avoid re-adding duplicate dirs.)

---

## 7. Best-Practice Guidelines (2025-07)
* **Single Source:** All client code in `src/`; never edit `dist/`.
* **Atomic Commits:** Separate logical changes (features vs. content).
* **CI First:** Extend the build workflow with lint/test stages.
* **Docs Culture:** Add/modify files in `docs/` for every significant change.
* **Secrets:** Store keys in Cloudflare Pages env vars, never commit `.env`.
* **Branch Strategy:** `main` (prod), short-lived feature branches, PR review required.
* **Long-Term Dependencies:** Pin major versions; run `npm audit` quarterly.

---

## 8. Next Steps for Future Agents
1. Merge the open PR once CI passes and smoke tests succeed.
2. Verify Cloudflare Pages output directory update.
3. Tag a release (e.g., `v2.0.0-consolidation`).
4. Plan next milestones (PWA enhancements, React migration, etc.).

Welcome aboard and happy hacking!
